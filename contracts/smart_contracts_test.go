// Copyright (C) 2022, Chain4Travel AG. All rights reserved.
//
// This file is a derived work, based on ava-labs code whose
// original notices appear below.
//
// It is distributed under the same license conditions as the
// original code from which it is derived.
//
// Much love to the original authors for their work.
// **********************************************************

// (c) 2019-2020, Ava Labs, Inc. All rights reserved.
// See the file LICENSE for licensing terms.

package contracts

import (
	"fmt"
	"math/big"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/crypto"

	c4tAbi "github.com/chain4travel/caminoethvm/accounts/abi"
	c4tBind "github.com/chain4travel/caminoethvm/accounts/abi/bind"
	c4tBackends "github.com/chain4travel/caminoethvm/accounts/abi/bind/backends"
	access "github.com/chain4travel/caminoethvm/contracts/build_contracts/access/src"
	c4tCore "github.com/chain4travel/caminoethvm/core"

	"github.com/chain4travel/caminoethvm/core/rawdb"
	"github.com/chain4travel/caminoethvm/params"
)

var (
	// generated smart contract bin and abi
	adminBin  = "608060405234801561001057600080fd5b50610d25806100206000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c80634de525d9116100715780634de525d91461013c5780635c97f4a21461016c5780639a11b2e81461019c578063bb03fa1d146101b8578063ce6ccfaf146101e8578063fdff0b2614610218576100a9565b80630900f010146100ae5780630912ed77146100ca57806315e812ad146100e65780633c09e2fd146101045780634686069814610120575b600080fd5b6100c860048036038101906100c39190610916565b610234565b005b6100e460048036038101906100df9190610a19565b610302565b005b6100ee61035c565b6040516100fb9190610bca565b60405180910390f35b61011e60048036038101906101199190610a19565b610366565b005b61013a60048036038101906101359190610a55565b6103c0565b005b6101566004803603810190610151919061098e565b61044d565b6040516101639190610bca565b60405180910390f35b61018660048036038101906101819190610a19565b610474565b6040516101939190610b6f565b60405180910390f35b6101b660048036038101906101b1919061093f565b610488565b005b6101d260048036038101906101cd9190610916565b6105c9565b6040516101df9190610bca565b60405180910390f35b61020260048036038101906101fd9190610916565b610612565b60405161020f9190610bca565b60405180910390f35b610232600480360381019061022d91906109ca565b610624565b005b60016102403382610696565b61027f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161027690610baa565b60405180910390fd5b73010000000000000000000000000000000000000a73ffffffffffffffffffffffffffffffffffffffff1663d784d426836040518263ffffffff1660e01b81526004016102cc9190610b2b565b600060405180830381600087803b1580156102e657600080fd5b505af11580156102fa573d6000803e3d6000fd5b505050505050565b600161030e3382610696565b61034d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161034490610baa565b60405180910390fd5b61035783836106e4565b505050565b6000600154905090565b60016103723382610696565b6103b1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103a890610baa565b60405180910390fd5b6103bb838361076e565b505050565b60026103cc3382610696565b61040b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161040290610baa565b60405180910390fd5b816001819055507f1c053aa9b674900648619554980ac10e913d661c372ca30455e1e4ec0ce44071826040516104419190610bca565b60405180910390a15050565b60006003600061045d8585610841565b815260200190815260200160002054905092915050565b60006104808383610696565b905092915050565b60046104943382610696565b6104d3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104ca90610baa565b60405180910390fd5b6000600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490506000846105265783821761052b565b831982165b905080600260008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508573ffffffffffffffffffffffffffffffffffffffff167ff64784c1c207eed151b4adc53adde03b1c3a4ecad6b8de3a65539d464b3e1add83836040516105b9929190610be5565b60405180910390a2505050505050565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600061061d82610871565b9050919050565b60086106303382610696565b61066f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161066690610baa565b60405180910390fd5b816003600061067e8787610841565b81526020019081526020016000208190555050505050565b600080826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054161415905092915050565b80196000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825416925050819055507fcfa5316bd1be4ceb62f363b0a162f322c33ba870641138cd8600dd4fa603fc3b8282604051610762929190610b46565b60405180910390a15050565b6107766108b9565b8111156107b8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107af90610b8a565b60405180910390fd5b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825417925050819055507f385a9c70004a48177c93b74796d77d5ebf7e1248f9e2369624514da454cd01b08282604051610835929190610b46565b60405180910390a15050565b600060148260e01c63ffffffff16901b8373ffffffffffffffffffffffffffffffffffffffff1617905092915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60006008905090565b6000813590506108d181610c93565b92915050565b6000813590506108e681610caa565b92915050565b6000813590506108fb81610cc1565b92915050565b60008135905061091081610cd8565b92915050565b60006020828403121561092857600080fd5b6000610936848285016108c2565b91505092915050565b60008060006060848603121561095457600080fd5b6000610962868287016108c2565b9350506020610973868287016108d7565b925050604061098486828701610901565b9150509250925092565b600080604083850312156109a157600080fd5b60006109af858286016108c2565b92505060206109c0858286016108ec565b9150509250929050565b6000806000606084860312156109df57600080fd5b60006109ed868287016108c2565b93505060206109fe868287016108ec565b9250506040610a0f86828701610901565b9150509250925092565b60008060408385031215610a2c57600080fd5b6000610a3a858286016108c2565b9250506020610a4b85828601610901565b9150509250929050565b600060208284031215610a6757600080fd5b6000610a7584828501610901565b91505092915050565b610a8781610c1f565b82525050565b610a9681610c31565b82525050565b6000610aa9600c83610c0e565b91507f556e6b6e6f776e20526f6c6500000000000000000000000000000000000000006000830152602082019050919050565b6000610ae9600d83610c0e565b91507f4163636573732064656e696564000000000000000000000000000000000000006000830152602082019050919050565b610b2581610c89565b82525050565b6000602082019050610b406000830184610a7e565b92915050565b6000604082019050610b5b6000830185610a7e565b610b686020830184610b1c565b9392505050565b6000602082019050610b846000830184610a8d565b92915050565b60006020820190508181036000830152610ba381610a9c565b9050919050565b60006020820190508181036000830152610bc381610adc565b9050919050565b6000602082019050610bdf6000830184610b1c565b92915050565b6000604082019050610bfa6000830185610b1c565b610c076020830184610b1c565b9392505050565b600082825260208201905092915050565b6000610c2a82610c69565b9050919050565b60008115159050919050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b610c9c81610c1f565b8114610ca757600080fd5b50565b610cb381610c31565b8114610cbe57600080fd5b50565b610cca81610c3d565b8114610cd557600080fd5b50565b610ce181610c89565b8114610cec57600080fd5b5056fea26469706673582212204b444e84b87b88884208b48dd50f670b26569c2f6626585e98add499d8b8956d64736f6c63430008000033"
	adminAbi  = "[{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"DropRole\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newGasFee\",\"type\":\"uint256\"}],\"name\":\"GasFeeSet\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"oldState\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newState\",\"type\":\"uint256\"}],\"name\":\"KycStateChanged\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"SetRole\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"},{\"internalType\":\"bool\",\"name\":\"remove\",\"type\":\"bool\"},{\"internalType\":\"uint256\",\"name\":\"state\",\"type\":\"uint256\"}],\"name\":\"applyKycState\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getBaseFee\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"},{\"internalType\":\"bytes4\",\"name\":\"signature\",\"type\":\"bytes4\"}],\"name\":\"getBlacklistState\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"getKycState\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"}],\"name\":\"getRoles\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"grantRole\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"hasRole\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"revokeRole\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"newFee\",\"type\":\"uint256\"}],\"name\":\"setBaseFee\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"},{\"internalType\":\"bytes4\",\"name\":\"signature\",\"type\":\"bytes4\"},{\"internalType\":\"uint256\",\"name\":\"state\",\"type\":\"uint256\"}],\"name\":\"setBlacklistState\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newImplementation\",\"type\":\"address\"}],\"name\":\"upgrade\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newImplementation\",\"type\":\"address\"}],\"name\":\"setImplementation\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"DropRole\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"SetRole\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"DropRole\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"SetRole\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"}],\"name\":\"getRoles\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"grantRole\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"hasRole\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"revokeRole\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]"
	accessBin = "608060405234801561001057600080fd5b50610657806100206000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c80630912ed77146100515780633c09e2fd1461006d5780635c97f4a214610089578063ce6ccfaf146100b9575b600080fd5b61006b60048036038101906100669190610412565b6100e9565b005b61008760048036038101906100829190610412565b610143565b005b6100a3600480360381019061009e9190610412565b61019d565b6040516100b09190610524565b60405180910390f35b6100d360048036038101906100ce91906103e9565b6101b1565b6040516100e0919061057f565b60405180910390f35b60016100f533826101c3565b610134576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161012b9061055f565b60405180910390fd5b61013e8383610211565b505050565b600161014f33826101c3565b61018e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101859061055f565b60405180910390fd5b610198838361029b565b505050565b60006101a983836101c3565b905092915050565b60006101bc8261036e565b9050919050565b600080826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054161415905092915050565b80196000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825416925050819055507fcfa5316bd1be4ceb62f363b0a162f322c33ba870641138cd8600dd4fa603fc3b828260405161028f9291906104fb565b60405180910390a15050565b6102a36103b6565b8111156102e5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102dc9061053f565b60405180910390fd5b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825417925050819055507f385a9c70004a48177c93b74796d77d5ebf7e1248f9e2369624514da454cd01b082826040516103629291906104fb565b60405180910390a15050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60006001905090565b6000813590506103ce816105f3565b92915050565b6000813590506103e38161060a565b92915050565b6000602082840312156103fb57600080fd5b6000610409848285016103bf565b91505092915050565b6000806040838503121561042557600080fd5b6000610433858286016103bf565b9250506020610444858286016103d4565b9150509250929050565b610457816105ab565b82525050565b610466816105bd565b82525050565b6000610479600c8361059a565b91507f556e6b6e6f776e20526f6c6500000000000000000000000000000000000000006000830152602082019050919050565b60006104b9600d8361059a565b91507f4163636573732064656e696564000000000000000000000000000000000000006000830152602082019050919050565b6104f5816105e9565b82525050565b6000604082019050610510600083018561044e565b61051d60208301846104ec565b9392505050565b6000602082019050610539600083018461045d565b92915050565b600060208201905081810360008301526105588161046c565b9050919050565b60006020820190508181036000830152610578816104ac565b9050919050565b600060208201905061059460008301846104ec565b92915050565b600082825260208201905092915050565b60006105b6826105c9565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6105fc816105ab565b811461060757600080fd5b50565b610613816105e9565b811461061e57600080fd5b5056fea26469706673582212205371197e5e60911dc434990a9c887f0446aedfcedba59b6da4a2bb674624a2f764736f6c63430008000033"
	accessAbi = "[{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"DropRole\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"SetRole\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"}],\"name\":\"getRoles\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"grantRole\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"hasRole\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"role\",\"type\":\"uint256\"}],\"name\":\"revokeRole\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]"

	gasLimit = uint64(10000000)

	key, _ = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
	addr   = crypto.PubkeyToAddress(key.PublicKey)
)

func TestAccessSmartContracts(t *testing.T) {
	opts, _ := c4tBind.NewKeyedTransactorWithChainID(key, big.NewInt(1337))

	alloc := createGenesisAllocation(addr)

	// sim := c4tBackends.NewSimulatedBackend(alloc, gasLimit)
	// sim := backends.NewSimulatedBackend(alloc, gasLimit)
	sim := c4tBackends.NewSimulatedBackendWithInitialAdmin(rawdb.NewMemoryDatabase(), alloc, gasLimit, addr)
	defer sim.Close()

	parsed, _ := c4tAbi.JSON(strings.NewReader(accessAbi))
	contractAddr, _, _, _ := c4tBind.DeployContract(opts, parsed, common.FromHex(accessBin), sim)

	sim.Commit(true)

	accessContract, _ := access.C4TNewBuild(contractAddr, sim)

	accessSession := access.C4TBuildSession{Contract: accessContract, TransactOpts: *opts}

	sim.Commit(true)

	role, err := accessSession.C4TGetRoles(contractAddr)

	fmt.Println("1 role and error : ", role, err)

	tx, err := accessSession.C4TGrantRole(contractAddr, big.NewInt(100000000))
	fmt.Println("1 tx and err : ", tx, err)
	sim.Commit(true)
}

func createGenesisAllocation(addr common.Address) c4tCore.GenesisAlloc {
	eip1967Key := common.HexToHash("0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc")
	adminKey := addr.Hash()

	alloc := make(c4tCore.GenesisAlloc)

	implAddress := common.HexToAddress("0x010000000000000000000000000000000000000b")
	alloc[addr] = c4tCore.GenesisAccount{
		Balance: big.NewInt(params.Ether),
		Storage: map[common.Hash]common.Hash{
			eip1967Key: implAddress.Hash(),
			adminKey:   addr.Hash(),
		},
	}

	return alloc
}
